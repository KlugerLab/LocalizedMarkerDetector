---
title: "Paper_Figure"
author: "Ruiqi Li"
output: pdf_document
date: '2023-10-16'
---
# Load Data & Preprocess
```{r}
library("Seurat")
library("RColorBrewer")
library("dplyr")
library("patchwork")
library("ggplot2")
library("ggsignif")
source("LMD_function.R", echo = F)
dir.path0 = "/banach1/ruiqi/local_marker"
dir.path1 = "/banach1/ruiqi/Peggy_data/Peggy_scdata/240329_smom2"
figure_path = file.path(dir.path0, "LMD_data","figures")
dir.create(figure_path,recursive = TRUE)
setwd(figure_path)
```

# SupFig - Bone Marrow Cell Embedding
```{r}
dir.path <- file.path(dir.path0,"LMD_data")
consortium = "tabular_muris"
folder.path <- file.path(dir.path,consortium)
tissue_name = "marrow_facs"
tiss <- readRDS(file.path(folder.path,paste0(tissue_name,".rds")))
cell_label = tiss$cell_ontology_class
coldef = setNames(colorRampPalette(brewer.pal(12, "Paired"))(length(unique(cell_label))),unique(cell_label))
p1 = DimPlot(tiss, group.by = "cell_ontology_class",label = FALSE, cols = coldef) + guides(color = guide_legend(ncol = 1,override.aes = list(size = 3))) + labs(title = NULL)

tissue_name = "marrow_droplet"
tiss <- readRDS(file.path(folder.path,paste0(tissue_name,".rds")))
cell_label = tiss$cell_ontology_class
coldef = setNames(colorRampPalette(brewer.pal(12, "Paired"))(length(unique(cell_label))),unique(cell_label))
p2 = DimPlot(tiss, group.by = "cell_ontology_class",label = FALSE, cols = coldef) + guides(color = guide_legend(ncol = 1,override.aes = list(size = 3))) + labs(title = NULL)

p = ((p1 / p2) + plot_annotation(tag_levels = 'A')) & theme(plot.tag = element_text(size = 20))
ggsave(filename = file.path(figure_path,"supfig-bonemarrow.png"), plot = p, width = 8, height = 10, dpi = 300)
```

# Fig - Pipeline
```{r}
source("LMD_function.R", echo = F)
dir.path <- file.path(dir.path0,"LMD_data")
consortium = "tabular_muris"
folder.path <- file.path(dir.path,consortium)
tissue_name = "marrow_facs"
tiss <- readRDS(file.path(folder.path,paste0(tissue_name,".rds")))
W <- readRDS(file.path(folder.path,"intermediate_data",tissue_name,paste0(tissue_name,"_knn_graph.rds")))
res <- readRDS(file.path(folder.path,"intermediate_data",tissue_name,paste0(tissue_name,"_lmd_profile.rds")))
P_ls <- readRDS(file.path(folder.path,"intermediate_data",tissue_name,paste0(tissue_name,"_diffused_graph.rds")))
rho <- readRDS(file.path(folder.path,"intermediate_data",tissue_name,paste0(tissue_name,"_gene_distribution.rds")))
```
```{r}
# Plot knn graph
p = plot_knn_graph(affinity_m = W, layout = Embeddings(tiss[["tsne"]])) + NoLegend()
ggsave(filename = file.path(figure_path,"fig-pipeline1.png"), plot = p, width = 5, height = 5, dpi = 300)
```
```{r}
# Check Diffusion KL pattern for several genes
# good gene: Igll1,Fcnb # garbage marker: Fkbp1b, Tnks1bp1, Magi2,Uchl4
genes = c("Igll1","Tnks1bp1") 
# genes_label = c("localized","non_localized")
check_time = c(0,2^3,2^9,2^14)
p = Visualize_score_pattern(res$score_profile/res$score_profile$max_score0, genes = genes, add_point = check_time) + guides(linetype = "none")

# ggsave(filename = file.path(figure_path,"fig-pipeline2.png"), plot = p, width = 10, height = 5)

ggsave(filename = file.path(figure_path,"fig-pipeline2.png"), plot = p, width = 8, height = 5)
```
```{r}
# Check Gene Diffusion on Cell graph by time
pl = lapply(1:length(genes),function(i){
  gene = genes[i]
  FeaturePlot_diffusion(coord = Embeddings(tiss[["tsne"]]),init_state = rho[gene,,drop = FALSE],P_ls = P_ls,W = W,check_time = check_time,gene_name = NULL, gene_color = scales::hue_pal()(length(genes))[i])
})
p = as.ggplot(pl[[1]]) / as.ggplot(pl[[2]] & labs(title = NULL))
ggsave(filename = file.path(figure_path,"fig-pipeline3.png"), plot = p, width = 16, height = 8)
```

# Fig - the AUROC given the rank and the ground truth
```{r}
method_ls = c("lmd","haystack","hotspot","marcopolo","semi","wilcox_no_filter","hvg")
method_fullname = setNames(c("LMD","singleCellHaystack","Hotspot","Marcopolo","SEMITONES","Seurat v4","HVGs"),method_ls)
```
```{r}
dir.path <- dir.path0
consortium = "tabular_muris"
tissue_name = "marrow_facs"
folder.path = file.path(dir.path, "LMD_data","benchmark")
```
```{r}
# Define Full name
tissue_ls = list("tabular_muris" = c("marrow_facs","pancreas_facs","lung_facs"),
                 "azimuth" = c("human_kidney", "human_bone_marrow", "human_pancreas", "mouse_motor_cortex", "human_lung_hlca", "human_motor_cortex"))
consortium_full_name = c("tabular_muris" = "Tabular Muris","azimuth" = "Azimuth")
tissue_full_name = lapply(unlist(tissue_ls),function(i){
  tmp_name = 
  if(grepl("marrow",i)){tmp_name = "Bone Marrow"}
  else if(grepl("lung_hlca",i)){tmp_name = "Lung v2 (HLCA)"}
  else if(grepl("lung",i)){tmp_name = "Lung"}
  else if(grepl("pancreas",i)){tmp_name = "Pancreas"}
  else if(grepl("kidney",i)){tmp_name = "Kidney"}
  else if(grepl("motor_cortex",i)){tmp_name = "Motor Cortex"}
  else{tmp_name = NA}
  tmp_name
})
names(tissue_full_name) = unlist(tissue_ls)
tissue_full_name = unlist(lapply(1:length(tissue_full_name),function(i){
  ori_name = names(tissue_full_name)[i]
  if(grepl("_facs|mouse",ori_name)){
    tmp_name = paste0("Mouse-\n",tissue_full_name[i])
  }
  else if(grepl("human",ori_name)){
    tmp_name = paste0("Human-\n",tissue_full_name[i])
  }
  else{
    tmp_name = tissue_full_name[i]
  }
  tmp_name
}))
names(tissue_full_name) = unlist(tissue_ls)
```
```{r}
df_auc = do.call(rbind,
                lapply(1:length(tissue_ls),function(i){
                  df_all = NULL
                  for(j in tissue_ls[[i]]){
                    df = read.table(file.path(folder.path, names(tissue_ls)[i],paste0(j,"_auroc.csv")),header = TRUE)
                    df$'Tissue' = j
                    df_all = rbind(df_all,df)
                  }
                  df_all$'consortium' = names(tissue_ls)[i]
                  df_all}))
df_auc$Method = method_fullname[df_auc$Method]
df_auc = df_auc %>% filter(gt_set %in% c("CellMarkerDB","Top100"))
# Order Method based on mean AUROC
df_auc$Method <- with(df_auc, reorder(Method, -AUROC, FUN = median))
df_auc$gt_set <- factor(df_auc$gt_set,levels = c("CellMarkerDB","Top100"))
levels(df_auc$gt_set) = c("Criterion1-\n CellMarkerDB","Criterion2-\n MaxFC")
df_auc$Tissue = tissue_full_name[df_auc$Tissue]
df_auc$consortium = consortium_full_name[df_auc$consortium]
df_auc$consortium = factor(df_auc$consortium, levels = consortium_full_name)
```
## Figure
```{r}
coldef = setNames(
  colorRampPalette(brewer.pal(8, "Set1"))(length(method_fullname)),
  method_fullname)

fig <- ggplot(df_auc, aes(x = Tissue, y = AUROC, fill = Method)) +
  geom_bar(stat = "identity", position = "dodge") + facet_grid(gt_set~consortium, scales = 'free') +
  geom_text(aes(label = round(AUROC, 3)), position = position_dodge(width = 1), vjust = -0.25, size = 2.5, angle = 45) +
  labs(x = "Tissue", y = "AUROC", fill = "Method") + coord_cartesian(ylim = c(0.5, 1)) +
  theme(legend.position = "bottom")  +  scale_fill_manual(values= coldef[names(coldef)%in%df_auc$Method]) 

fig = fig + theme(
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 10),
          axis.title.x = element_text(size = 15),
          axis.title.y = element_text(size = 15),
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 10),
          panel.grid = element_blank(),
          axis.line = element_line(colour = "black"),
          panel.background = element_blank(),
          strip.background = element_rect(fill = "white", color = "white") ,
          strip.text = element_text(size = 15, color = "black"))

ggsave(filename = file.path(figure_path,"fig-known_marker_comparison.png"), plot = fig, width = 12, height = 6)
```
## Table
```{r}
library("reshape2")
wide_data = df_auc; wide_data$AUROC = round(wide_data$AUROC,3)
wide_data <- reshape2::dcast(wide_data, gt_set + Tissue + consortium ~ Method, value.var = "AUROC")
colnames(wide_data)[1:3] = c("Criterion","Tissue","DataSource")
wide_data[,1:3] = wide_data[,3:1]; colnames(wide_data)[1:3]=colnames(wide_data)[3:1]
wide_data <- wide_data[order(wide_data$DataSource,wide_data$Tissue,wide_data$Criterion),]
wide_data[,1:3] = apply(wide_data[,1:3],2,function(x) gsub("[\n]|Criterion1-|Criterion2-","",x))
wide_data[,1:2] = apply(wide_data[,1:2],2,function(x) {x[duplicated(x)] = "";x})
wide_data$Tissue[17] = "Motor Cortex(Mouse)"
wide_data$Tissue[13] = "Motor Cortex(Human)"
wide_data$Tissue = gsub("Human-|Mouse-","",wide_data$Tissue)
# calculate average
avg_tmp = wide_data %>%
    group_by(Criterion) %>%
    summarize(across(3:(ncol(wide_data)-1), ~ round(mean(.x, na.rm = TRUE), 3)))
avg_tmp$DataSource = c("Average",""); avg_tmp$Tissue = "-"
wide_data = rbind(wide_data,avg_tmp)
bold_max <- function(vec) {
  max_val <- max(vec, na.rm = TRUE)
  vec = unlist(ifelse(vec == max_val, paste0("\\textbf{", vec, "}"), vec))
  return(vec)
}
wide_data[,4:ncol(wide_data)] = t(apply(wide_data[,4:ncol(wide_data)],1,bold_max))
wide_data[is.na(wide_data)] = "-"

write.csv(wide_data, file = file.path(folder.path,"AUROC_table.csv"), row.names = FALSE)
```
# SupFig-RunTime
```{r}
df_runtime = do.call(rbind,
                lapply(1:length(tissue_ls),function(i){
                  df_all = NULL
                  for(j in tissue_ls[[i]]){
                    df = read.table(file.path(folder.path, names(tissue_ls)[i],paste0(j,"_runtime.csv")),header = TRUE)
                    df$'Tissue' = j
                    df_all = rbind(df_all,df)
                  }
                  df_all$'consortium' = names(tissue_ls)[i]
                  df_all}))
df_runtime$Method = method_fullname[df_runtime$Method]
df_runtime$Tissue = tissue_full_name[df_runtime$Tissue]
df_runtime$consortium = consortium_full_name[df_runtime$consortium]
```
## Figure
```{r}
coldef = setNames(
  colorRampPalette(brewer.pal(8, "Set1"))(length(method_fullname)),
  method_fullname)

fig <- ggplot(df_runtime, aes(x = nCells, y = Time, color = Method)) +
  geom_point(aes(size = nGenes)) + geom_line(aes(group = Method)) + scale_y_log10() + scale_x_continuous(breaks = c(1e3,2e3,5e3,1e4,2e4,3e4), labels = c("1k","2k","5k","10k","20k","30k")) +
  geom_hline(aes(yintercept = 30), linetype = "dashed") + 
  annotate("text", x = 0, y = 30, label = "30 min",  vjust = -0.5) + 
  geom_hline(aes(yintercept = 60), linetype = "dashed") + annotate("text", x = 0, y = 60, label = "1 hr",  vjust = -0.5) + 
  scale_color_manual(values= coldef[names(coldef)%in%df_runtime$Method]) +
  labs(x = "nCells", y = "RunTime(minutes)", color = "Method")

fig = fig + theme(
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 10),
          axis.title.x = element_text(size = 15),
          axis.title.y = element_text(size = 15),
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 10),
          panel.grid = element_blank(),
          axis.line = element_line(colour = "black"),
          panel.background = element_blank(),
          strip.background = element_rect(fill = "white", color = "white") ,
          strip.text = element_text(size = 15, color = "black"))

ggsave(filename = file.path(figure_path,"supfig-runtime.png"), plot = fig, width = 8, height = 5)
```
## Table
```{r}
df_runtime = df_runtime %>% filter(Method == "LMD") %>% arrange(Time, nCells, nGenes) %>% select(c("Time","nCells","nGenes")) %>% mutate(Time = round(Time, 2))
colnames(df_runtime)[1] = "Time (min)"
write.csv(df_runtime, file = file.path(folder.path,"RunTime_table.csv"), row.names = FALSE)
```

# Fig - Gene Ranking Comparisons between LMD and Other Methods
```{r}
dir.path <- dir.path0
consortium = "tabular_muris"
tissue_name = "marrow_facs"
df_benchmark = read.table(file.path(dir.path, "LMD_data","benchmark", consortium, paste0(tissue_name,"_benchmark_rank_table.csv")),header = TRUE)
rownames(df_benchmark) = df_benchmark$gene
tiss = readRDS(file.path(dir.path, "LMD_data",consortium, paste0(tissue_name,".rds")))
method_vs = "lmd"
method_vs_set = c("wilcox_no_filter","hotspot","marcopolo","semi","haystack")
```
```{r}
sub = do.call(c,lapply(method_vs_set,function(method){
  sub = c(which(df_benchmark[,method] <= 100 & df_benchmark[,method_vs] > 500),
          which(df_benchmark[,method] > 500 & df_benchmark[,method_vs] <= 100) )
  sub
}))
df_label_all = df_benchmark[unique(sub),c(method_vs,method_vs_set)]
# df_label_all$'legend' = sapply(seq(nrow(df_label_all)),function(i){
#   paste(paste(method_fullname[colnames(df_label_all)],df_label_all[i,],sep = ":"),collapse = "\n")
# })
g = c("Cd19","Naaa","Mogat2","Grina","Abca13","Zf12","Il2rb","Phgdh","Vpreb2","Fyb")
names(g) = rep(method_vs_set,each = 2)
pl = lapply(1:length(g),function(i){
  x = g[i]
  subtitle = sprintf("%s:%d, %s:%d",method_fullname[method_vs],df_label_all[x,method_vs],method_fullname[names(g)[i]],df_label_all[x,names(g)[i]])
  color_label = ifelse(df_label_all[x,method_vs] > df_label_all[x,names(g)[i]],"blue","red")
  FeaturePlot(tiss,features = x,order =TRUE) + labs(color = "Expression") + labs(title = x,subtitle = subtitle) + 
    theme(
      plot.title = element_text(face="bold", size = 30,color = color_label),
      plot.subtitle = element_text(size = 20),
      legend.title = element_text(size = 20),
      legend.text = element_text(size = 15),
      axis.title = element_blank(),
      axis.text = element_blank(),
      axis.ticks=element_blank(),
      axis.line = element_blank())
  # + annotation_custom(grob = grid::textGrob(df_label_all[x,"legend"], x = 1, y = 1, just = c("right", "top"),gp = grid::gpar(col = "red", fontsize = 10)))
})
pl = pl[order(seq(length(g))%%2,decreasing = TRUE)]
pl[[1]] = pl[[1]] + labs(y = "Favored by LMD") + theme(axis.title.y = element_text(size = 20,face="bold", colour = "red"))
pl[[(length(pl)/2)+1]] = pl[[(length(pl)/2)+1]] + labs(y = "Favored by Other methods") + theme(axis.title.y = element_text(size = 20,face="bold", colour = "blue"))

fig = wrap_plots(pl,nrow = 2)

ggsave(filename = file.path(figure_path,"fig-ranking_comparison2.png"), plot = fig, width = 25, height = 10)
```
```{r}
pl_rank = lapply(method_vs_set,function(method){
  df_label = data.frame(df_benchmark[,c(method,method_vs)],label = rownames(df_benchmark))
  fullmethod = method_fullname[method]
  fullmethodvs = method_fullname[method_vs]
  df_label[c(which(df_label[,method] <= 100 & df_label[,method_vs] > 500)),"color"] = fullmethod
  df_label[c(which(df_label[,method] > 500 & df_label[,method_vs] <= 100) ),"color"] = fullmethodvs
  df_label$'color' = factor(df_label$'color',levels = c(fullmethodvs,fullmethod))
  rank_cor = stats::cor(log(df_label[,1:2],base = 10),method = "pearson")[1,2]
  colnames(df_label)[1:2] = c("x","y")
  p = ggplot(df_label, aes(x=x, y=y,color = color)) + geom_point(size = 1) + 
  scale_color_manual(values = c("red","blue","grey50"),
                     breaks = c(fullmethodvs,fullmethod),
                     labels = c("Favored by LMD","Favored by Other methods")) + 
    geom_abline(intercept = 0, slope = 1, col = "grey", linetype = "dashed") + 
    scale_x_log10(breaks = 10^(0:4), labels = expression(10^0, 10^1, 10^2, 10^3, 10^4)) +
    scale_y_log10(breaks = 10^(0:4), labels = expression(10^0, 10^1, 10^2, 10^3, 10^4)) + 
    expand_limits(x = c(1, 10^4), y = c(1, 10^4)) +
    labs(x = paste0(method_fullname[method]," Rank"), 
         y = paste0(method_fullname[method_vs]," Rank"),
         color = "Highlighted Genes",
         title = paste("cor =", round(rank_cor, 2)))
  # annotate gene labels
  p = p + ggrepel::geom_text_repel(data = df_label %>% filter(!is.na(color)) %>% filter(label %in% g), aes(label=label),min.segment.length = unit(0, 'lines'),nudge_y = -0.5,show.legend = FALSE,size = 5)
  p = p + theme(
    plot.title = element_text(size = 15),
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 15),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"))
})
for(i in 2:length(pl_rank)){
  pl_rank[[i]] <- pl_rank[[i]] + theme(axis.title.y=element_blank())
}
p = (wrap_plots(pl_rank,nrow = 1) & theme(legend.position="bottom")) + plot_layout(guides = "collect")

ggsave(filename = file.path(figure_path,"fig-ranking_comparison1.png"), plot = p, width = 25, height = 6)
```


<!-- # Fig - Gene Co-localization Module Benchmark -->
<!-- ```{r} -->
<!-- library(cowplot) -->
<!-- library(patchwork) -->
<!-- source("./LMD_function.R", echo = F) -->

<!-- path = "./benchmark_result/" -->
<!-- tissue_name = "marrow_facs" -->

<!-- df_benchmark = read.table(paste0(path,tissue_name,"_benchmark_rank_table.csv")) -->
<!-- method = "lmd" -->
<!-- topn = 2000 -->
<!-- # Gene prioritized by lmd -->
<!-- pl1 = lapply(c("wilcox_default","haystack","hotspot","hvg"),function(method_vs){ -->
<!--   local_gene = setdiff(rownames(df_benchmark)[order(df_benchmark[,method_vs])][1:topn], rownames(df_benchmark)[order(df_benchmark[,method])][1:topn]) -->

<!--   ## Gene-gene distance(similarity)--------- -->
<!--   distance_method = "jaccard" -->
<!--   clustering_method = "average" -->
<!--   dist = Calculate_distance(dat_alra[local_gene,], method = distance_method) -->

<!--   gene_hree = hclust(dist, method = clustering_method) -->
<!--   gene_partition = cutree(gene_hree,k=5) -->
<!--   names(gene_partition) = labels(dist) -->

<!--   top5 <- names(sort(table(gene_partition),decreasing = TRUE))[1:5] -->
<!--   annotation_df = data.frame(Module = gene_partition) -->
<!--   ann_colors = list( -->
<!--     Module = c(setNames(colorRampPalette(brewer.pal(9, "Set1"))(5),1:5))) -->

<!--   p_heatmap = pheatmap(as.matrix(dist), -->
<!--                 annotation_col = annotation_df, -->
<!--                 cluster_rows = gene_hree, -->
<!--                 cluster_cols = gene_hree, -->
<!--                 treeheight_row = 0, -->
<!--                 annotation_colors = ann_colors,  -->
<!--                 col=colorRampPalette(c("red","white","blue4"))(99), -->
<!--                 show_colnames = FALSE, -->
<!--                 show_rownames = FALSE, -->
<!--                 annotation_legend = TRUE, -->
<!--                 silent = TRUE) -->
<!--   pl_module = FeaturePlot_meta(dat,visual_space,gene_partition) -->
<!--   legend <- get_legend(pl_module[[1]]) -->
<!--   prow <- cowplot::plot_grid(plotlist = lapply(pl_module,function(x) x + theme(legend.position="none")), ncol = ceiling(length(pl_module)/2)) -->

<!--   as.ggplot(p_heatmap) + cowplot::plot_grid(prow, legend, rel_widths = c(ceiling(length(pl_module)/2), .2)) + plot_annotation(title = sprintf("Genes in top 2000 by %s but not by %s (N = %d)",method_fullname[method_vs],method_fullname[method],length(local_gene))) + plot_layout(ncol = 2, widths = c(2, 3)) -->
<!-- }) -->
<!-- # The other way around -->
<!-- pl2 = lapply(c("wilcox_default","haystack","hotspot","hvg"),function(method_vs){ -->
<!--   local_gene = setdiff(rownames(df_benchmark)[order(df_benchmark[,method])][1:topn], rownames(df_benchmark)[order(df_benchmark[,method_vs])][1:topn]) -->

<!--   ## Gene-gene distance(similarity)--------- -->
<!--   distance_method = "jaccard" -->
<!--   clustering_method = "average" -->
<!--   dist = Calculate_distance(dat_alra[local_gene,], method = distance_method) -->

<!--   gene_hree = hclust(dist, method = clustering_method) -->
<!--   gene_partition = cutree(gene_hree,k=5) -->
<!--   names(gene_partition) = labels(dist) -->

<!--   top5 <- names(sort(table(gene_partition),decreasing = TRUE))[1:5] -->
<!--   annotation_df = data.frame(Module = gene_partition) -->
<!--   ann_colors = list( -->
<!--     Module = c(setNames(colorRampPalette(brewer.pal(9, "Set1"))(5),1:5))) -->

<!--   p_heatmap = pheatmap(as.matrix(dist), -->
<!--                 annotation_col = annotation_df, -->
<!--                 cluster_rows = gene_hree, -->
<!--                 cluster_cols = gene_hree, -->
<!--                 treeheight_row = 0, -->
<!--                 annotation_colors = ann_colors,  -->
<!--                 col=colorRampPalette(c("red","white","blue4"))(99), -->
<!--                 show_colnames = FALSE, -->
<!--                 show_rownames = FALSE, -->
<!--                 annotation_legend = TRUE, -->
<!--                 silent = TRUE) -->
<!--   pl_module = FeaturePlot_meta(dat,visual_space,gene_partition) -->
<!--   legend <- get_legend(pl_module[[1]]) -->
<!--   prow <- cowplot::plot_grid(plotlist = lapply(pl_module,function(x) x + theme(legend.position="none")), ncol = ceiling(length(pl_module)/2)) -->

<!--   as.ggplot(p_heatmap) + cowplot::plot_grid(prow, legend, rel_widths = c(ceiling(length(pl_module)/2), .2)) + plot_annotation(title = sprintf("Genes in top 2000 by %s but not by %s (N = %d)",method_fullname[method],method_fullname[method_vs],length(local_gene))) + plot_layout(ncol = 2, widths = c(2, 3)) -->
<!-- }) -->

<!-- pdf(width = 12.5,height = 5) -->
<!-- pl1 -->
<!-- dev.off() -->

<!-- pdf(width = 12.5,height = 5) -->
<!-- pl2 -->
<!-- dev.off() -->
<!-- ``` -->


# SupFig - Density Index
```{r}
# Set the color code for all methods
method_ls = c("lmd","haystack","hotspot","marcopolo","semi","wilcox_no_filter","hvg")
method_fullname = setNames(c("LMD","singleCellHaystack","Hotspot","Marcopolo","SEMITONES","Seurat v4","HVGs"),method_ls)
coldef = setNames(
  colorRampPalette(brewer.pal(8, "Set1"))(length(method_fullname)),
  method_fullname)
```

```{r}
consortium = "tabular_muris"
dir.path <- file.path(dir.path0,"LMD_data")
pl = lapply(c("marrow_facs","lung_facs","pancreas_facs"),function(tissue_name){
score_measure = read.table(file.path(dir.path,"benchmark",consortium,paste0(tissue_name,"_DI.csv")),header = TRUE)
score_measure$Method = ifelse(score_measure$Method %in% names(method_fullname),method_fullname[score_measure$Method],score_measure$Method)

baseline = score_measure %>% filter(Method == "All genes") %>%.$DensityIndex

fig = ggplot(score_measure %>% filter(Method!="All genes"), aes(x = TopGene, y = DensityIndex, color = Method, group = Method, linetype = Method)) + 
  geom_line(size = 1) +
  scale_x_log10(breaks = 10^(2:4), labels = expression(10^2, 10^3, 10^4)) +
    # expand_limits(x = c(50, 10^4)) +
  geom_hline(aes(yintercept = baseline, color = "All genes", linetype = "All genes"))

# Add null distribution
null_score_measure =
  read.table(file.path(dir.path,"benchmark",consortium,paste0(tissue_name,"_DI_null.csv")),header = TRUE)
# Calculate the mean & Prediction Interval
## account for both the variability of the observations and the uncertainty in estimating the mean
null_stats <- null_score_measure %>%
  group_by(TopGene) %>% 
  summarize(Mean = mean(DensityIndex),Sd = sd(DensityIndex),sample_size = n(),.groups = 'drop') %>%
  mutate( Lower_CI = Mean + qt(0.025, df = sample_size - 1) * Sd * sqrt(1 + 1 / sample_size), Upper_CI = Mean + qt(0.975, df = sample_size - 1) * Sd * sqrt(1 + 1 / sample_size) )
null_stats$'Method' = "Null"

fig = fig + geom_line(data = null_stats, aes(x = TopGene, y=Mean)) + geom_ribbon(data = null_stats, aes(x = TopGene, y=Mean, ymin=Lower_CI, ymax=Upper_CI), alpha=0.2, inherit.aes = FALSE)

# Add format
coldef["All genes"] = "black";  coldef["Null"] = "grey"
linetypedef = coldef; linetypedef[1:7] = "solid"; linetypedef[8:9] = "dashed"
fig = fig + ggtitle(ifelse(grepl("marrow",tissue_name),"Bone Marrow",ifelse(grepl("lung",tissue_name),"Lung",ifelse(grepl("pancreas",tissue_name),"Pancreas",NA)))) + xlab("# of Top Genes") + 
  scale_color_manual(values = coldef, labels = names(coldef), breaks = names(coldef)) + 
  scale_linetype_manual(values = linetypedef,labels = names(linetypedef), breaks = names(linetypedef))

# Add LowQualityRate Scatterplot
top_gene_labeller = as_labeller(setNames(paste0("N = ",unique(score_measure$TopGene)),unique(score_measure$TopGene)))
fig2 = ggplot(score_measure %>% filter(Method!="All genes") %>% filter(TopGene %in% c(50,100,500)), aes(x = 1 - LowQualityRate, y = DensityIndex, color = Method)) + geom_point() + xlim(0,1) + xlab("Percentage of Cells covered by Top N Genes") + scale_color_manual(values = coldef) + 
  guides(color = "none") + facet_wrap(~TopGene, labeller = top_gene_labeller)

(fig+fig2 + plot_layout(widths = c(1, 2)))  & theme(
    plot.title = element_text(face="bold", size = 20),
    legend.title = element_blank(),
    legend.text = element_text(size = 10),
    # legend.position = "bottom",
    legend.justification = 1,
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 10),
    # panel.grid = element_blank(),
    # panel.background = element_blank(),
    axis.line = element_line(colour = "black"))
})
```
```{r}
fig = wrap_plots(pl,ncol = 1) + plot_layout(guides = "collect") & theme(legend.position = 'bottom')
ggsave(filename = file.path(figure_path,"supfig-densityindex.png"), plot = fig, width = 12, height = 12)

# Only keep Bone Marrow
fig = wrap_plots(pl[[1]],ncol = 1) + plot_layout(guides = "collect") + plot_annotation(tag_levels = "A") & theme(legend.position = 'bottom', plot.tag = element_text(size = 20))
ggsave(filename = file.path(figure_path,"supfig-densityindex.png"), plot = fig, width = 12, height = 5)
```

# SupFig - Sensitivity Test
## kNN
```{r}
folder.path = file.path(dir.path,"LMD_data",consortium,"intermediate_data", tissue_name, "sensitivity_test")
test_para = "knn"

## Rank Stability
df = read.table(file.path(folder.path,sprintf("%s_jaccard_ind_%s.csv",tissue_name,test_para)),header = TRUE)
df$knn = as.factor(as.numeric(gsub("\\D", "", df$knn)))
df$Top_Genes = as.factor(df$Top_Genes)
fig1 = ggplot(data = df, aes(x = knn, y = JaccardIndex, group = Top_Genes, color = Top_Genes)) +
  geom_line() +
  geom_point() + labs(x = "# of kNN used", y = "Jaccard Index\n (with kNN5)",color = "Top Genes") + geom_vline(xintercept = 3, color="red", linetype="dashed") + 
  scale_y_continuous(limits = c(0,1)) +
  theme(
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 15),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"))

# AUC stability
df = read.table(file.path(folder.path,sprintf("%s_auroc_%s.csv",tissue_name,test_para)),header = TRUE)
df = df %>% filter(gt_set %in% c("Top100","CellMarkerDB"))
df$gt_set = factor(df$gt_set)
levels(df$gt) = ifelse(grepl("CellMarkerDB",levels(df$gt)),levels(df$gt),"MacFC(Top100)")
df$Parameter = as.factor(as.numeric(gsub("\\D", "", df$Parameter)))

fig2 = ggplot(data = df, aes(x = Parameter, y = AUROC, group = gt_set, color = gt_set)) +
  geom_line() +
  geom_point() + labs(x = "# of kNN used", y = "AUROC", color = "Gold-Standard Genesets") + 
  scale_y_continuous(limits = c(0,1)) +
  theme(
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 15),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"))

# fig = fig1 + fig2 + plot_annotation(title = "Sensitivity Test: Different kNN", theme = theme(plot.title = element_text(size = 20)))
# ggsave(filename = file.path(figure_path,"supfig-sensitivityknn.png"), plot = fig, width = 16, height = 5)
```
## PC
```{r}
folder.path = file.path(dir.path,"LMD_data",consortium,"intermediate_data", tissue_name, "sensitivity_test")
test_para = "pc"

## Rank Stability
df = read.table(file.path(folder.path,sprintf("%s_jaccard_ind_%s.csv",tissue_name,test_para)),header = TRUE)
df$pc = ifelse(grepl("tSNE",df$pc),"tSNE",gsub("\\D", "", df$pc))
df$pc = factor(df$pc,levels = c(sort(unique(as.numeric(df$pc))),"tSNE"))
df$Top_Genes = as.factor(df$Top_Genes)
fig3 = ggplot(data = df, aes(x = pc, y = JaccardIndex, group = Top_Genes, color = Top_Genes)) +
  geom_line() +
  geom_point() + labs(x = "# of PC used", y = "Jaccard Index\n (with 20PC)", color = "Top Genes") + geom_vline(xintercept = 2, color="red", linetype="dashed") + 
  scale_y_continuous(limits = c(0,1)) +
  theme(
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 15),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"))

# AUC stability
df = read.table(file.path(folder.path,sprintf("%s_auroc_%s.csv",tissue_name,test_para)),header = TRUE)
df = df %>% filter(gt_set %in% c("Top100","CellMarkerDB"))
df$gt_set = factor(df$gt_set)
levels(df$gt) = ifelse(grepl("CellMarkerDB",levels(df$gt)),levels(df$gt),"MacFC(Top100)")
df$Parameter = ifelse(grepl("tSNE",df$Parameter),"tSNE",gsub("\\D", "", df$Parameter))
df$Parameter = factor(df$Parameter,levels = c(sort(unique(as.numeric(df$Parameter))),"tSNE"))

fig4 = ggplot(data = df, aes(x = Parameter, y = AUROC, group = gt_set, color = gt_set)) +
  geom_line() +
  geom_point() + labs(x = "# of PC used", y = "AUROC", color = "Gold-Standard Genesets") + 
  scale_y_continuous(limits = c(0,1)) +
  theme(
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 15),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"))

# fig = fig3 + fig4 + plot_annotation(title = "Sensitivity Test: Different PC", theme = theme(plot.title = element_text(size = 20)))
# ggsave(filename = file.path(figure_path,"supfig-sensitivitypc.png"), plot = fig, width = 16, height = 5)
```
```{r}
p = (fig1 + fig2) / (fig3 + fig4) + plot_layout(guides = "collect") + plot_annotation(tag_level = 'A') & theme(plot.tag = element_text(face="bold", size = 20)) 
ggsave(filename = file.path(figure_path,"supfig-sensitivity.png"), plot = p, width = 16, height = 10)
```


# SupFig - Gene Modules - Bone Marrow
## Cut-off of localized genes
```{r}
# load("./marrow_result/module_result.rdata")
source("LMD_function.R", echo = F)
# celltype_color = setNames(colorRampPalette(brewer.pal(9, "Set1"))(length(unique(cell_label))),unique(cell_label))
consortium = "tabular_muris"
tissue_name = "marrow_facs"
dir.path <- file.path(dir.path0,"LMD_data")
folder.path = file.path(dir.path,consortium)
dist = readRDS(file.path(folder.path,"intermediate_data",tissue_name,paste0(tissue_name,"_gene_dist.rds")))
res = readRDS(file.path(folder.path,"intermediate_data",tissue_name,paste0(tissue_name,"_gene_tree.rds")))
local_gene = readRDS(file.path(folder.path,"intermediate_data",tissue_name,paste0("local_gene_",tissue_name,".rds")))
p0 <- ggplot(local_gene$gene_table, aes(x = rank, y = score)) + geom_point() + geom_vline(xintercept = length(local_gene$cut_off_gene), linetype="dashed", color="grey", lwd = 1) + geom_point(aes(x = length(local_gene$cut_off_gene), y = local_gene$gene_table$score[length(local_gene$cut_off_gene)]), color = "red", size = 5) +  # Add a red point at index 50
  labs(x = "Rank", y = "LMDS") + theme(
    plot.title = element_text(size = 30),
    axis.title = element_text(size = 20),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.text = element_text(size = 15),
    axis.line = element_line(colour = "black"))
```
## Gene-Gene Jaccard-dist HeatMap
```{r}
p1 = Visualize_gene_heatmap(dist, gene_partition = res$gene_partition_rename, gene_hree = res$gene_hree)
```
## Module Activity Score
```{r}
tiss = readRDS(file.path(folder.path,paste0(tissue_name,".rds")))
modules = levels(res$gene_partition_rename)
pl_module = lapply(modules,function(module){
  module_name = paste0("Module",module)
  (FeaturePlot(tiss, features = module_name, order = TRUE) + 
    scale_color_gradient(low = "lightgrey", high = "blue", limits = c(0,1)) +
    ggtitle(sprintf("Module %s (%d genes)", module, sum(res$gene_partition_rename == module))) + labs(color = "ModuleScore")) & NoAxes()
})
names(pl_module) = modules
p2 = (wrap_plots(pl_module,ncol = 7) &  theme(plot.title = element_text(face="bold", size = 10),legend.title = element_text(size = 30),legend.text = element_text(size = 20))) + plot_layout(guides = "collect")
p2 = as.ggplot(p2)

# ggsave(filename = file.path(figure_path,"supfig-moduletsne.png"), plot = p, width = 7*3, height = 5*3)
```
```{r}
p = (p0 + p1 + p2) + plot_layout(design = paste0("AA#BBB#\n###BBB#",paste0(rep("\nCCCCCCC",3),collapse = ""))) + plot_annotation(tag_levels = 'A') & theme(plot.tag = element_text(face="bold", size = 25))
ggsave(filename = file.path(figure_path,"supfig-obtainmodule.png"), plot = p, width = 21, height = 9 + 5*3)
```


# SupFig-CellType-specific Module (Bone marrow)
## Jaccard Index Heatmap
```{r}
consortium = "tabular_muris"
tissue_name = "marrow_facs"
dir.path <- file.path(dir.path0,"LMD_data")
folder.path = file.path(dir.path,consortium)

one_hot_matrix <- 
  readRDS(file.path(folder.path,"intermediate_data",tissue_name,paste0(tissue_name,"_ct_onehot_mtx.rds")))

jaccard_index <- 
  readRDS(file.path(folder.path,"intermediate_data",tissue_name,paste0(tissue_name,"_ct_module_jaccard.rds")))
```
```{r}
thred = 0.4
jaccard_index_pruned = jaccard_index[apply(jaccard_index,1,max) >= thred,]
jaccard_index_pruned = jaccard_index_pruned[,apply(jaccard_index_pruned,2,max) >= thred]

colnames(jaccard_index_pruned) = gsub("Module","M",colnames(jaccard_index_pruned))
jaccard_index_pruned = jaccard_index_pruned[names(sort(apply(jaccard_index_pruned,1,which.max))),]
p1 = Visualize_jaccard_mtx(jaccard_index_pruned, threshold = thred)
p1 = as.ggplot(p1) + coord_fixed()
```
##  Module-CT-TSNE
For each cell type, select the most specific modules for visualization (maximum jaccard index)
```{r}
pl_ct = lapply(colnames(one_hot_matrix),function(ct){
  FeaturePlot_custom(coord = Embeddings(tiss[["tsne"]]),value = as.character(one_hot_matrix[,ct]), title_name = ct, value_name = "Indicator") + scale_color_manual(values = c("0" = "lightgrey", "1" = scales::hue_pal()(1)))
})
names(pl_ct) = colnames(one_hot_matrix)

ct_module_match = apply(jaccard_index,1,function(x) colnames(jaccard_index)[which.max(x)])
ct_module_match = gsub("Module","",ct_module_match)
ct_module_match["granulocyte"] = "11"
ct_module_match["granulocytopoietic cell"] = "8"

pl <- lapply(seq(length(ct_module_match)),function(i){
    pl_module[[ct_module_match[i]]]/
    pl_ct[[names(ct_module_match)[i]]]
})
names(pl) = names(ct_module_match)
pl = pl[rownames(jaccard_index_pruned)]
p2 = (wrap_plots(pl,ncol = ceiling(length(pl)/2)) & theme(plot.title = element_text(face="bold", size = 10),legend.title = element_text(size = 15),legend.text = element_text(size = 10))) + plot_layout(guides = "collect")
p2 = as.ggplot(p2)
# p = (wrap_plots(pl,ncol = 8) & theme(plot.title = element_text(face="bold", size = 20),legend.title = element_text(size = 15),legend.text = element_text(size = 10))) + plot_layout(guides = "collect")
# ggsave(filename = "supfig-ct-specific-module1.png", plot = p, width = 3*8, height = 6)
```
```{r}
# # Bipartite Plot
# jaccard_thred = 0.4
# 
# library(igraph)
# library("grid") 
# library("gridExtra") 
# 
# df_edge <- as.data.frame(as.table(jaccard_index))
# colnames(df_edge) = c("from","to","weight")
# df_edge <- subset(df_edge, weight > jaccard_thred)
# df_edge$width = ifelse(df_edge$weight > 0.8,2,0.5)
# df_node = data.frame(name=c(names(module_color),names(celltype_color)),color = c(module_color,celltype_color))
# df_node$type = ifelse(df_node$name %in% names(module_color),TRUE,FALSE)
# 
# # Define specific color for module
# rownames(df_node) = df_node$name
# ct_module = names(which(apply(jaccard_index,2,max) > jaccard_thred))
# ct_subtype_module = c(4,5,6,30,39,42,43)
# ct_multype_module = c(2,13,19,33,36,54)
# cc_module = c(16,17,18,31)
# df_node[names(module_color),"color"] = "grey"
# df_node[ct_module,"color"] = "red"
# df_node[ct_multype_module,"color"] = "purple"
# df_node[ct_subtype_module,"color"] = "yellow"
# df_node[cc_module,"color"] = "green"
# 
# g <- graph_from_data_frame(df_edge, directed=FALSE, vertices=df_node)
# V(g)$shape <- ifelse(V(g)$type, "circle", "square")
# E(g)$color <- ifelse(E(g)$weight > 0.8, "red", "grey")
# l <- layout_as_bipartite(g, types=!V(g)$type)
# 
# plot(g, layout=l, vertex.size=2, vertex.label=ifelse(V(g)$type, V(g)$name, NA), vertex.frame.color = NA, asp=0.2, 
#      vertex.label.cex=0.5,
#      vertex.label.dist=-1,
#      vertex.label.degree=pi/2)
# 
# # Create Node Legend & Edge Legend
# color_label = c("green" = "cell cycle",purple = "multi cell type",red = "cell type",yellow = "cell subtype")
# df_node$subtype = color_label[df_node$color]
# 
# p <- ggplot(df_node %>% filter(type), aes(x = 0, y = 0,color = subtype)) + geom_point(size = 7) + scale_color_manual(values= setNames(names(color_label),color_label)) + theme_minimal() + labs(color = "Module Type") + theme(legend.direction="horizontal")
# grid.newpage()
# grid.draw(get_legend(p))
# 
# p <- ggplot(df_node %>% filter(!type), aes(x = 0, y = 0,color = name)) + geom_point(size = 7,shape = 15) + scale_color_manual(values= df_node %>% filter(!type) %>% pull(color,name)) + theme_minimal() + labs(color = "Cell Type") + theme(legend.direction="horizontal")
# grid.newpage()
# grid.draw(get_legend(p))
```

## Transfer Jaccard Index
```{r}
jaccard_index = lapply(c("marrow_facs","marrow_droplet"), function(tissue_name) readRDS(file.path(folder.path,"intermediate_data",tissue_name,paste0(tissue_name,"_ct_module_jaccard.rds"))))
one_hot_matrix = lapply(c("marrow_facs","marrow_droplet"), function(tissue_name) readRDS(file.path(folder.path,"intermediate_data",tissue_name,paste0(tissue_name,"_ct_onehot_mtx.rds"))))
```
```{r}
module_selected = unique(unlist(apply(jaccard_index[[1]][rownames(jaccard_index[[2]]),],1,function(x) colnames(jaccard_index[[1]])[which(x > thred)])))
module_selected = module_selected[order(as.numeric(gsub("Module","",module_selected)))]

ct_selected = unique(unlist(apply(jaccard_index[[1]][rownames(jaccard_index[[2]]),module_selected],2,function(x) rownames(jaccard_index[[2]])[which(x > thred)])))
ct_selected = names(sort(apply(jaccard_index[[1]][ct_selected,],1,which.max)))

pl = lapply(jaccard_index,function(mtx){
  jaccard_index_pruned = mtx[ct_selected,module_selected]
  colnames(jaccard_index_pruned) = gsub("Module","M",colnames(jaccard_index_pruned))
  Visualize_jaccard_mtx(jaccard_index_pruned,threshold = thred)
})
titles = c("FACS","Droplet")
pl <- lapply(1:length(pl), function(i){pl[[i]] + labs(title = titles[i]) + theme(plot.title = element_text(size = 20, face = "bold"))})
p3 = wrap_plots(pl,ncol = 2) + plot_layout(guides = "collect")
p3 = as.ggplot(p3)
```
```{r}
p = (p2 + p1 + p3) + plot_annotation(tag_levels = "A") + plot_layout(design = "AAAB\nAAAB\nAAAB\nAAAB\nCC##\nCC##\nCC##") & theme(plot.tag = element_text(face="bold", size = 25))

ggsave(filename = file.path(figure_path,"supfig-ct-specific-module.png"), plot = p, width = 3*6 + 8, height = 3*4 + 8)
# ggsave(filename = file.path(figure_path,"supfig-ct-specific-module2.png"), plot = p, width = 8, height = 10)
# ggsave(filename = file.path(figure_path,"supfig-ct-specific-module3.png"), plot = p, width = 10, height = 8)
```

# Fig - Cell Cycle (Bone Marrow)
## CC & Module TSNE
```{r}
consortium = "tabular_muris"
tissue_name = "marrow_facs"
dir.path <- file.path(dir.path0,"LMD_data")
folder.path = file.path(dir.path,consortium)
res = readRDS(file.path(folder.path,"intermediate_data",tissue_name,paste0(tissue_name,"_gene_tree.rds")))
tiss = readRDS(file.path(folder.path,paste0(tissue_name,".rds")))
tissue_name = "marrow_droplet"
tiss_droplet = readRDS(file.path(folder.path,paste0(tissue_name,".rds")))
reduction = "tsne_cc"
reduction = "tsne"
p1 = DimPlot(tiss,group.by = "Phase", shuffle = TRUE, reduction = reduction) + labs(title = "Phase annotated by Seurat",color = "Phase") + 
  scale_color_manual(values = c("grey",scales::hue_pal()(3)[3:2]), limits = c("G1","S","G2M")) + theme(
  plot.title = element_text(size = 10),
  axis.title = element_blank(),
      axis.text = element_blank(),
      axis.ticks=element_blank(),
      legend.title = element_text(size = 20),
      legend.text = element_text(size = 15),
      axis.line = element_blank())
p2 = DimPlot(tiss_droplet,group.by = "Phase", shuffle = TRUE, reduction = reduction) + 
  scale_color_manual(values = c("grey",scales::hue_pal()(3)[3:2]), limits = c("G1","S","G2M")) + labs(title = "Phase annotated by Seurat",color = "Phase") + theme(
  axis.title = element_blank(),
      axis.text = element_blank(),
      axis.ticks=element_blank(),
      legend.title = element_text(size = 20),
      legend.text = element_text(size = 15),
      axis.line = element_blank())

# cc_module = c(32,31,18)
cc_module = c(22,20,19)
pl_module_cc = lapply(cc_module,function(module){
  module_name = paste0("Module",module)
  (FeaturePlot(tiss, features = module_name, order = TRUE, reduction = reduction) + 
    scale_color_gradient(low = "lightgrey", high = "blue", limits = c(0,1)) +
    ggtitle(sprintf("Module %s (%d genes)", module, sum(res$gene_partition_rename == module))) + labs(color = "ModuleScore")) & NoAxes()
})
pl_module_cc_droplet = lapply(cc_module,function(module){
  module_name = paste0("Module",module)
  (FeaturePlot(tiss_droplet, features = module_name, order = TRUE, reduction = reduction) + 
    scale_color_gradient(low = "lightgrey", high = "blue", limits = c(0,1)) +
    ggtitle(sprintf("Module %s (%d genes)", module, sum(res$gene_partition_rename == module))) + labs(color = "ModuleScore")) & NoAxes()
})
p = wrap_plots(p1,wrap_plots(pl_module_cc,ncol = 3) & theme(plot.title = element_text(size = 15)) ,p2 + labs(title = NULL),wrap_plots(pl_module_cc_droplet,ncol = 3) & theme(plot.title = element_text(size = 15)) & labs(title = NULL),nrow = 2,design = "ABBB\nCDDD") + plot_layout(guides = "collect")

ggsave(filename = file.path(figure_path,"fig-module-cellcycle1.png"), plot = p, width = 3*4 + 1, height = 3*2)
# ggsave(filename = file.path(figure_path,"supfig-module-cellcycle.png"), plot = p, width = 3*4 + 1, height = 3*2)

p = wrap_plots(p1,wrap_plots(pl_module_cc,ncol = 3) +plot_layout(guides = "collect"),design = "ABBB") & theme(plot.title = element_text(size = 15))
ggsave(filename = file.path(figure_path,"supfig-module-cellcycle.png"), plot = p, width = 3*4 + 1, height = 3)
```
## Reactome enrichment
```{r}
df = read.csv(file.path(folder.path, "intermediate_data",tissue_name,"reactome_pathway_cc.csv"))
# select top5 pathway for each module
selected_terms = df %>% group_by(module) %>%
  arrange(p.adjust) %>%
  slice_head(n = 5) %>%
  ungroup() %>%.$Description
df = df %>% filter(Description %in% selected_terms)
df$GeneRatio = unlist(lapply(df$GeneRatio,function(x) eval(parse(text = x))))
df$Description = unlist(lapply(df$Description,function(i) add_newline_in_middle(i, 30)))
df$Description = as.factor(df$Description)
df$Description = factor(df$Description, levels(df$Description)[rev(c(2,4,3,6,10,1,5,9,7,8))])
cc_module = c(22,20,19)
df$module = factor(df$module,levels = cc_module)
levels(df$module) = paste0("Module",levels(df$module))
df$log.p.adj = -log(df$p.adjust,base = 10)
p = ggplot(df, aes(x=module, y=Description)) +
  geom_point(aes(size=GeneRatio, color=log.p.adj), alpha=0.7) +
  scale_color_gradientn(colors=colorRampPalette(c("blue","red"))(99), name="-log10(p.adj)") +
  theme_minimal() +
  labs(size="Gene Ratio",x = "Module", color = "-log10 p.adjust") +
  theme(legend.position="right",
        axis.title = element_text(size = 0),
        axis.text.x = element_text(size = 15, angle = 45),
      axis.text.y = element_text(size = 15),
      legend.title = element_text(size = 10),
      legend.text = element_text(size = 8))
ggsave(filename = file.path(figure_path,"fig-module-cellcycle2.png"), plot = p, width = 6, height = 6)
```

# SupFig - Joint-CT Module visualization
```{r}
# level0_module = c(13,27,38,46,54)
level0_module = c(4,16,28,17,33)
p = (wrap_plots(pl_module[level0_module],ncol = 5) &  theme(plot.title = element_text(size = 15))) + plot_layout(guides = "collect")

ggsave(filename = file.path(figure_path,"supfig-joint-module.png"), plot = p, width = 5*3, height = 3)
```

# Fig - Subtype Investigation
## B lymphoid
late pro -> precursor B -> immature -> Naive B
8(Lef1, Slamf7) - lateproB, 6(Vreb1,Igll1)- early preB, 7(Rag1, Rag2)/11(Chchd10) - lateproB-preB, 9(Ms4a1, Cd22) - immature-naive, 10 (Fcer2a, Ms4a4c, Cxcr5) - naive B

13 (Fcrla,Pax5,Cd79a,Cd19)
Dntt: 29 (HSC)
Rag1, Rag2, Dntt: early pro-B
Pax5, Vpreb1, Dntt, Cd19, Cd22-: late-proB
Vpreb1-, Dntt-, Pax5, Rag1, Rag2, Cd19, Chchd10, Cd22-, : pre-B
Chchd10,Cd79a,Cd19,Ms4a1,Pax5,Cd22: immature
Cd79a, Cd19, Ms4a1, Pax5, Rag1- Rag2-, Chchd10, Cd22: naive B

```{r}
# B_module = c(7,9,10)
# B_module_genes = list("8" = c("Lef1","Slamf7"),
#                       "6" = c("Vreb1","Igll1"),
#                       "7" = c("Rag1", "Rag2"),
#                       "9" = c("Ms4a1", "Cd22"),
#                       "10" = c("Fcer2a","Ms4a4c","Cxcr5"))

modules_genes = list("7" = c("Lef1","Enpep"), # late-proB
                      "6" = c("Rag2","Il7r"),
                      "2" = c("Ms4a1", "Cd22"),
                      "3" = c("Fcer2a","Cxcr5"))
cell_id = grep("B cell",tiss$cell_ontology_class)
cell_id = cell_id[tiss$cell_ontology_class[cell_id] != "B cell"]
```
## Granulocyte
Granulocyte: 
granulopoietic -> granulocyte
45 -> 44 -> 41 -> 43
45: "Fcnb"
44: "Camp", "Ltf",
41: "Retnlg", "Cxcr2"
43: Stfa2l1, Il1b, Gm5483, H2-Q10, and Irg1
```{r}
# G_module = c(45,44,41,43)
# G_module_genes = list("45" = c("Fcnb"),
#                       "44" = c("Camp", "Ltf"),
#                       "41" = c("Retnlg", "Cxcr2"),
#                       "43" = c("Stfa2l1", "Il1b", "Gm5483", "H2-Q10", "Irg1"))
modules_genes = list("8" = c("Ms4a3"),
                      "15" = c("Camp", "Ltf"),
                      "11" = c("Retnlg", "Cxcr2"),
                      "10" = c("Stfa2l1", "Il1b", "Gm5483", "H2-Q10"))

cell_id = which(tiss$cell_ontology_class %in% c("granulocyte","granulocytopoietic cell"))

```

```{r}
pl = lapply(names(modules_genes),function(module){
  module_name = paste0("Module",module)
  (FeaturePlot(subset(tiss, cells = colnames(tiss)[cell_id]), features = module_name, order = TRUE, reduction = "tsne") + 
    scale_color_gradient(low = "lightgrey", high = "blue", limits = c(0,1)) + labs(color = "ModuleScore", title = paste0("Module",module), subtitle = paste0(modules_genes[[as.character(module)]],collapse = ", "))) & NoAxes() & theme(
    plot.title = element_text(hjust = 0),
    plot.subtitle = element_text(hjust = 0))
})

cell_label = tiss$cell_ontology_class
coldef = setNames(colorRampPalette(brewer.pal(12, "Paired"))(length(unique(cell_label))),unique(cell_label))
p = DimPlot(subset(tiss,cells = colnames(tiss)[cell_id]), group.by = "cell_ontology_class",label = TRUE, cols = coldef,repel = TRUE,label.size = 3) + NoLegend() + labs(title = NULL) + NoAxes()

# p = wrap_plots(as.ggplot(p),(wrap_plots(pl,nrow = 1) &  theme(plot.title = element_text(size = 15))) + plot_layout(guides = "collect"), nrow = 1, design = "ABBBB")
# ggsave(filename = file.path(figure_path,"fig-subtypeB.png"), plot = p, width = 5*3, height = 3)

pB = c(list(p),pl)
pG = c(list(p),pl)
p = (wrap_plots(c(pB,pG),nrow = 2) &  theme(plot.title = element_text(size = 15))) + plot_layout(guides = "collect")
ggsave(filename = file.path(figure_path,"fig-module-subtype.png"), plot = p, width = 5*3, height = 3*2)
```

# SmoM2 Loading
```{r}
sample_ls = unlist(lapply(c("E13.5", "E14.5"),function(i) paste0(i,"_", c("MUT", "CTL"))))
sample_ls = paste0("smom2_dermal_",sample_ls)
sample_full_name = setNames(c("E13.5 SmoM2",
                              "E13.5 WT",
                              "E14.5 SmoM2",
                              "E14.5 WT"),sample_ls)

```
```{r}
dir.path = dir.path1
lapply(sample_ls,function(sample_name){
  assign(paste0("data_S_",sample_name), 
         readRDS(file.path(dir.path,"process_data",sprintf("data_S_%s.rds",sample_name))),
         envir = .GlobalEnv)
  assign(paste0("local_gene_",sample_name), 
         readRDS(file.path(dir.path,"intermediate_data",sprintf("local_gene_%s.rds",sample_name))),
         envir = .GlobalEnv)
  return(NULL)
})
```
```{r}
module_ls = readRDS(file.path(dir.path,"intermediate_data","module_ls.rds"))
module_ls_ref = lapply(module_ls,function(x) setNames(names(x),x)); names(module_ls_ref) = NULL
module_ls_ref = do.call(c,module_ls_ref)
module_ls_ref = setNames(paste0("Module",sub(".*_([0-9]+)$", "\\1", names(module_ls_ref))),names(module_ls_ref))
```
# SupFig - SmoM2 Cell Embedding
```{r}
pl = lapply(sample_ls,function(sample_name){
  data_S = get(paste0("data_S_",sample_name))
  p1 = DimPlot(data_S, 
          group.by = "celltype", shuffle = TRUE, cols = c("DC"="#d1495b", "UD" = "#edae49", "LD" = "#00798c")) + ggtitle(sample_full_name[sample_name]) & NoAxes()
  p2 = DimPlot(data_S, 
          group.by = "Phase", shuffle = TRUE) + ggtitle("") & NoAxes()
  list(p1,p2)
})
pl = unlist(pl,recursive = FALSE)

p = wrap_plots(pl,nrow=2,byrow = FALSE) + plot_layout(guides = "collect")

ggsave(filename = file.path(figure_path,"supfig-smom2.png"), plot = p, width = 12, height = 6)
```

# SupFig - Module Activity Score for 4 SmoM2 samples
```{r}
sample_name = sample_ls[4]
data_S = get(paste0("data_S_",sample_name))
local_gene = get(paste0("local_gene_",sample_name))
modules = levels(local_gene$gene_partition)
pl_module = lapply(modules,function(module){
  prefix = paste0("Module", sample_name, "_")
  FeaturePlot(data_S, features = paste0(prefix,module), order = TRUE) + 
    scale_color_gradient(low = "lightgrey", high = "blue", limits = c(0,1)) +
    ggtitle(sprintf("Module %s (%d genes)", module, sum(local_gene$gene_partition == module)))
})
names(pl_module) = modules
p = (wrap_plots(pl_module,ncol = 6) & 
    labs(color = "ModuleScore") & 
    NoAxes() & theme(plot.title = element_text(face="bold", size = 10),legend.title = element_text(size = 30),legend.text = element_text(size = 20)) ) + plot_layout(guides = "collect")

ggsave(filename = file.path(figure_path,"supfig-moduletsne_e13mut.png"), plot = p, width = 6*3 + 1, height = 3*3)
ggsave(filename = file.path(figure_path,"supfig-moduletsne_e13ctl.png"), plot = p, width = 6*3 + 1, height = 3*3)
ggsave(filename = file.path(figure_path,"supfig-moduletsne_e14mut.png"), plot = p, width = 6*3 + 1, height = 3*3)
ggsave(filename = file.path(figure_path,"supfig-moduletsne_e14ctl.png"), plot = p, width = 6*3 + 1, height = 3*3)
```

# Fig - SmoM2-fig1-CC
```{r}
data_S_merged = readRDS(file = file.path(dir.path,"process_data","data_S_smom2_dermal_E13.5.rds"))
```
```{r}
sample_name = sample_ls[1]
modules = module_ls[[sample_name]]
modules = modules[grepl("CC",names(modules))]
local_gene = get(paste0("local_gene_",sample_name))
pl = lapply(sample_ls[1:2],function(sample_name){
  data_S = get(paste0("data_S_",sample_name))
  pl_module = lapply(modules,function(module){
    module_id = sub(".*?(\\d+)$", "\\1", module)
    (FeaturePlot(data_S, features = module, order = TRUE) + 
      scale_color_gradient(low = "lightgrey", high = "blue", limits = c(0,1)) + 
        labs(title = sprintf("%s (%d genes)", module_ls_ref[module], sum(local_gene$gene_partition == module_id)), color = "ModuleScore")) & NoAxes()
  })
  names(pl_module) = modules
  p = DimPlot(data_S, 
          group.by = "Phase", shuffle = TRUE) + NoAxes()
  
  c(list(p),pl_module)
})
pl_merged = lapply(unique(data_S_merged$type),function(sample_name){
  data_S = subset(data_S_merged, type == sample_name)
  pl_module = lapply(modules,function(module){
    module_id = sub(".*?(\\d+)$", "\\1", module)
    (FeaturePlot(data_S, features = module, order = TRUE, reduction = "umap_cc") + 
      scale_color_gradient(low = "lightgrey", high = "blue", limits = c(0,1)) +
      ggtitle(sprintf("%s (%d genes)", module_ls_ref[module], sum(local_gene$gene_partition == module_id))) + labs(color = "ModuleScore")) & NoAxes()
  })
  names(pl_module) = modules
  p = DimPlot(data_S, 
          group.by = "Phase", shuffle = TRUE, reduction = "umap_cc") + NoAxes()
  c(list(p),pl_module)
})

pl = unlist(c(pl,pl_merged),recursive = FALSE)
pl = lapply(1:length(pl),function(i){
  if(i <= 4) pl[[i]]
  else pl[[i]] + theme(plot.title = element_blank())
})
p = wrap_plots(pl,nrow = 4) + plot_layout(guides = "collect")
ggsave(filename = file.path(figure_path, "fig-smom2_1a.png"), plot = p, width = 3*4 + 3, height = 3*4)
```

# SupFig - E13 merged embedding
```{r}
data_S_merged = readRDS(file = file.path(dir.path,"process_data","data_S_smom2_dermal_E13.5.rds"))

p1 = (DimPlot(data_S_merged, group.by = "type", shuffle = TRUE) & NoAxes()) + labs(title = "By Top2000 HVGs") 
p2 = (DimPlot(data_S_merged, group.by = "type", shuffle = TRUE, reduction = "umap_cc") & NoAxes()) + labs(title = "By 95 CC genes (Seurat)") 
p = (p1 + p2 + plot_layout(guides = "collect") + plot_annotation(tag_levels = "A")) & theme(
    plot.title = element_text(size = 15, face = "plain"),
    plot.tag = element_text(size = 20, face = "bold"))
ggsave(filename = file.path(figure_path, "supfig-smom2_E13_embed.png"), plot = p, width = 2*3+2, height = 3)
```

# Fig - SmoM2-fig1-Wnt
```{r}
sample_name = sample_ls[1]
modules = module_ls[[sample_name]]
modules = modules[grepl("DC|Wnt",names(modules))]
modules = modules[c(1,3,2)]
local_gene = get(paste0("local_gene_",sample_name))
pl = lapply(sample_ls[c(1,2,4)],function(sample_name){
  data_S = get(paste0("data_S_",sample_name))
  pl_module = lapply(modules,function(module){
    module_id = sub(".*?(\\d+)$", "\\1", module)
    (FeaturePlot(data_S, features = module, order = TRUE) + 
      scale_color_gradient(low = "lightgrey", high = "blue", limits = c(0,1)) +
      ggtitle(sprintf("%s (%d genes)", module_ls_ref[module], sum(local_gene$gene_partition == module_id))) + labs(color = "ModuleScore")) & NoAxes()
  })
  names(pl_module) = modules
  pl_module
})

pl = unlist(pl,recursive = FALSE)
pl = lapply(1:length(pl),function(i){
  if(i <= 3) pl[[i]]
  else pl[[i]] + theme(plot.title = element_blank())
})
p = wrap_plots(pl,nrow = 3) + plot_layout(guides = "collect")
ggsave(filename = file.path(figure_path, "fig-smom2_1b.png"), plot = p, width = 3*3 + 3, height = 3*3)
```
## Lef1 level
```{r}
df = read.csv(file.path(dir.path,"intermediate_data","e13_smom2_wnt_level_table.csv"))
gene = "Lef1"
df = left_join(df, df %>% group_by(wnt_related_module) %>% summarise(mean = mean(get(gene), na.rm = TRUE)), by = "wnt_related_module")
df$wnt_related_module = ifelse(df$wnt_related_module_fullname %in% names(module_ls_ref), module_ls_ref[df$wnt_related_module_fullname], df$wnt_related_module)
df$wnt_related_module = factor(df$wnt_related_module, levels = df %>% arrange(desc(mean)) %>% pull(wnt_related_module) %>% unique())

# breaks <- seq(0, 1, length.out = 11)
# labels <- paste0(head(breaks, -1), "~", tail(breaks, -1))
# df <- df %>% mutate(across(starts_with("Module"), ~ cut(., breaks = breaks, include.lowest = TRUE, labels = labels)))
# df_long <- df %>%
#   pivot_longer(cols = starts_with("Module"),
#                names_to = "Module", 
#                values_to = "Bin")
# df_long$Module = module_ls_ref[df_long$Module]
# df_long$Bin = as.factor(df_long$Bin)
# p = ggplot(df_long, aes(x = Bin, y = get(gene), color = Module)) +
#   geom_violin(aes(color = Module), scale = "width", position = position_dodge(width = 0.75)) +
#   geom_line(data = df_long %>%
#   group_by(Module, Bin) %>%
#   summarise(median_expression = median(get(gene)), .groups = 'drop'), aes(x = as.numeric(Bin), y = median_expression, group = Module, color = Module),position = position_dodge(width = 0.75)) +
#   labs(title = paste0("Expression of ",gene),
#        x = "ModuleScore (Binned)",
#        y = "Expression Level",
#        color = "Module") +
#   theme_minimal()
generate_combinations <- function(vec) {
  n <- length(vec)
  combinations <- list()
  for (i in 1:(n - 1)) {
    combinations[[i]] <- c(vec[i], vec[i + 1])
  }
  return(combinations)
}
p1 = ggplot(df, aes(x = wnt_related_module, y = get(gene), fill = mean)) +
  geom_boxplot() + 
  ggsignif::geom_signif(comparisons = generate_combinations(levels(df$wnt_related_module)),
              map_signif_level = TRUE,
              textsize = 3) + theme_minimal() +
  labs(title = "Lef1 (Wnt) level across Wnt-related modules", x = "", y = "Expression Level") + 
  scale_fill_gradient(low = "white", high = "darkgreen", name = "mean", 
                      limits = c(0,max(df$mean)))
p1 = p1 + theme(
    plot.title = element_text(size = 15),
    axis.title = element_text(size = 15),
    axis.text.x = element_text(size = 10,angle = 45),
    axis.text.y = element_text(size = 10),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 10),
    )
```
```{r}
data_S = get(paste0("data_S_",sample_name))
data_S$'Wnt.Module' = df$wnt_related_module
p2 = DimPlot(data_S, 
        group.by = "Wnt.Module", order = levels(data_S$'Wnt.Module'), 
        cols = setNames(c("#E41A1C","#1F78B4","#B2DF8A","lightgrey"),levels(data_S$'Wnt.Module'))) + labs(title = "Active Cells for Wnt-related modules") & NoAxes()
p2 = p2 + theme(
    plot.title = element_text(size = 15, face = "plain"))
p = wrap_plots(p2,p1) 

ggsave(filename = file.path(figure_path, "fig-smom2_1c.png"), plot = p, width = 10, height = 5)
```

# Fig - SmoM2-fig2
```{r}
modules = module_ls$smom2_dermal_E13.5_MUT["Quiescent Module"]
# thred = 0.5
pl = lapply(sample_ls, function(sample_name){
  cat(sample_name,"\n")
  data_S = get(paste0("data_S_",sample_name))
  if("umap_cc_regressout" %in% names(data_S@reductions)){
    lapply(c("umap","umap_cc_regressout"),function(reduc){
    cat(reduc,"\n")
    p1 = DimPlot(data_S, 
             group.by = "Phase", shuffle = TRUE, reduction = reduc) + labs(title = "", color = "Phase") & NoAxes()
    p2 = FeaturePlot(data_S, features = modules, order = TRUE, reduction = reduc) + NoAxes() + 
    scale_color_gradient(low = "lightgrey", high = "blue", limits = c(0,1)) + labs(title = "", color = "ModuleScore")
    # if(reduc == "umap"){
    #   cc_count = table(data_S$Phase[data_S@meta.data[,modules] > thred])
    #   p2 = p2 + labs(subtitle = sprintf("%d Active Cells \n (%d in G1, %d in G2M, %d in S)",sum(cc_count), cc_count["G1"],cc_count["G2M"],cc_count["S"]))
    # }
    list(p1 + theme(aspect.ratio = 0.89),p2 + theme(aspect.ratio = 0.9))
  })
  }else{
    FeaturePlot(data_S, features = modules, order = TRUE, reduction = "umap") + NoAxes() + 
    scale_color_gradient(low = "lightgrey", high = "blue", limits = c(0,1)) + labs(title = "", color = "ModuleScore") + theme(aspect.ratio = 0.9)
  }
})
pl = do.call(c,lapply(pl,function(p){
  if(class(p) == "list"){
    unlist(p,recursive = FALSE)
  }else{
    list(p)
  }
}))
p = wrap_plots(pl,nrow = 2,widths = c(0.88,1,0.88,1,1)) + plot_layout(guides = "collect")
ggsave(filename = file.path(figure_path, "fig-smom2_2a.png"), plot = p, width = 3*5+3, height = 2*3 + 1)
```
## Supfig-Cdkn1a+ Lef1 level
```{r}
sample_name = sample_ls[1]
df = read.csv(file.path(dir.path,"intermediate_data","e13_smom2_cdkn1a_table.csv"))
gene = "Lef1"
df = left_join(df, df %>% group_by(status) %>% summarise(mean = mean(get(gene), na.rm = TRUE)), by = "status")
df$status = sub(colnames(df)[4],module_ls_ref[colnames(df)[4]],df$status)
df$status = factor(df$status, levels = df %>% arrange(desc(mean)) %>% pull(status) %>% unique())
df$status_ori = df$status; levels(df$status_ori) = sprintf("%s (%d cells)",levels(df$status_ori),table(df$status_ori)[levels(df$status_ori)])
levels(df$status)[which(table(df$status) < 10)] = NA
levels(df$status) = sub("Cdkn1a", "\nCdkn1a", levels(df$status))
generate_combinations <- function(vec) {
  n <- length(vec)
  combinations <- list()
  for (i in 1:(n - 1)) {
    combinations[[i]] <- c(vec[i], vec[i + 1])
  }
  return(combinations)
}
p1 = ggplot(df %>% filter(!is.na(status)), aes(x = status, y = get(gene), fill = mean)) +
  geom_boxplot() + 
  ggsignif::geom_signif(comparisons = generate_combinations(levels(df$status)),
              map_signif_level = TRUE,
              textsize = 3) + theme_minimal() +
  labs(x = "", y = "Lef1 (Wnt) level") + 
  scale_fill_gradient(low = "white", high = "darkgreen", name = "mean", 
                      limits = c(0,max(df$mean)))
p1 = p1 + theme(
    plot.title = element_text(size = 15),
    axis.title = element_text(size = 15),
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 10),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 10),
    )
```
```{r}
data_S = get(paste0("data_S_",sample_name))
data_S$'status' = df$status_ori
p2 = DimPlot(data_S, 
        group.by = "status", order = levels(data_S$'status')[c(3,2,1,4)], 
        cols = setNames(c("#B2DF8A","#1F78B4","#E41A1C","lightgrey"),levels(data_S$'status'))) + labs(title = "Active Cells for Quiescent-related cells") & NoAxes()
p2 = p2 + theme(
    plot.title = element_text(size = 15, face = "plain"))
p = (wrap_plots(p2,p1) + plot_annotation(tag_levels = "A")) & theme(plot.tag = element_text(size = 20, face = "bold"))

ggsave(filename = file.path(figure_path, "supfig-smom2_quiest_module.png"), plot = p, width = 12, height = 5)
```

# Supfig - SmoM2-Colocalization
## Module
```{r}
df = read.csv(file = file.path(dir.path,"intermediate_data","module_colocalize_align.csv"))
pl = lapply(unique(df$sample),function(sample_name){
  data_S = get(paste0("data_S_",sample_name))
  df_sub = df %>% filter(sample == sample_name)
  pl1 = lapply(1:nrow(df_sub),function(i){
    module1 = df_sub[i,"module1"]
    module2 = df_sub[i,"module2"]
    ji = df_sub[i,"jaccard_index"]
    p1 = FeaturePlot(data_S, features = module1, order = TRUE) + ggtitle(module_ls_ref[module1])
    p2 = FeaturePlot(data_S, features = module2, order = TRUE) + labs(title = module_ls_ref[module2], subtitle = sprintf("(JI: %.3f)",ji))
    (p1 / p2) & scale_color_gradient(low = "lightgrey", high = "blue", limits = c(0,1)) & NoAxes() & labs(color = "ModuleScore")
  })
})
p1 = wrap_plots(c(pl[[1]][c(2,4,3,1)],pl[[2]][1],pl[[3]][c(1:3)]),nrow = 1) + plot_layout(guides = "collect")

# ggsave(filename = file.path(figure_path,"supfig-smom2_colocalized1.png"), plot = p, width = 25, height = 6)
```

## Pathway enrichment plot
```{r}
pathway_result = readRDS(file.path(dir.path,"intermediate_data","pathway_result.rds"))

msig_df = do.call(rbind,lapply(sample_ls,function(sample_name){
  msig_result = pathway_result[[sample_name]][["msig"]]
  df <- do.call(rbind, lapply(names(msig_result), 
                            function(i) data.frame(msig_result[[i]]@result, module = i)))
  df <- df[!is.na(df$Description), ]
  df$GeneRatio = unlist(lapply(df$GeneRatio,function(x) eval(parse(text = x))))
  df$module = paste0("Module",sample_name,"_",df$module)
  df$'sample' = sample_full_name[sample_name]
  df
}))

msig_df$module_name = module_ls_ref[msig_df$module]
tmp_module_name = names(unlist(module_ls)[match(msig_df$module,unlist(module_ls))])
msig_df$module_class = ifelse(grepl("CC",tmp_module_name),"Cell Cycle", ifelse(grepl("DC|Wnt",tmp_module_name),"Wnt-related", ifelse(grepl("Quiescent",tmp_module_name),"Quiescent",NA)))
```
```{r}
pl = lapply(c("Cell Cycle","Wnt-related","Quiescent"),function(c){
  msig_df_filtered = msig_df %>% filter(module_class == c) %>% filter(pvalue < 0.05)
  # select top5 pathway for each module
  selected_terms = msig_df_filtered %>% group_by(module) %>% arrange(p.adjust) %>% slice_head(n = 5) %>%
    ungroup() %>%.$Description
  msig_df_filtered = msig_df_filtered %>% filter(Description %in% selected_terms)
  
  ggplot(msig_df_filtered, aes(x=module_name, y=Description)) +
    geom_point(aes(size=GeneRatio, color=pvalue), alpha=0.7) +
    scale_color_gradientn(colors=colorRampPalette(c("red", "blue"))(99), name="pvalue",limits = c(0,0.05)) + scale_size_continuous(name = "Gene Ratio", limits = c(0, 1)) + 
    labs(size="Gene Ratio",x = "Module") + facet_grid(~sample,switch = "x",scales = "free") + ggtitle(c)
})

p2 = (wrap_plots(pl, nrow = 1) & theme_minimal() & 
    theme(legend.position="right",
          plot.title = element_text(size = 20),
          axis.title = element_text(size = 10),
          axis.text.y = element_text(size = 10),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 10),
    panel.spacing.x = unit(0,"line"),
      axis.text.x = element_text(angle = 45),
          strip.placement = 'outside',
          strip.background.x = element_blank()) ) + plot_layout(guides = "collect")

# ggsave(filename = file.path(figure_path,"supfig-smom2_colocalized2.png"), plot = p, width = 20, height = 5)

p = (as.ggplot(p1)/as.ggplot(p2)) + plot_annotation(tag_levels = 'A') & theme(plot.tag = element_text(face="bold", size = 25))

ggsave(filename = file.path(figure_path,"supfig-smom2_colocalized.png"), plot = p, width = 20, height = 11)
```

# SupsupFig - Boxplot of ModuleActivityScore of active cells
```{r}
nn_score_df = read.csv(file.path(dir.path,"intermediate_data","neighbors_module_score.csv"))
nn_score_df$module = factor(nn_score_df$module,levels = c("Wnt Module","High-Wnt Module","DC Module","Quiescent Module"))
nn_score_df$sample = factor(nn_score_df$sample, levels = unique(nn_score_df$sample))
levels(nn_score_df$sample) = c("E13.5 SmoM2", "E13.5 WT", "E14.5 SmoM2", "E14.5 WT")
nn_score_df$knn = as.factor(nn_score_df$knn)
  
p = ggplot(nn_score_df %>% 
         filter(!(module!="Quiescent Module" & sample == "E14.5 SmoM2")), aes(x = knn, y = value, color = sample)) + 
  geom_boxplot() + 
  labs(y = "Average ModuleActivityScore", x = "KNN") +
  theme_minimal() + ylim(0,1) + facet_wrap(~module, ncol = 3)
ggsave(filename = file.path(figure_path,"supsupfig-smom2_neighbor_modulescore.png"), plot = p, width = 6, height = 4)
```


