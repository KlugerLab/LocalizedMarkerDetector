---
title: "Tutorial for Runing LMD on Mouse Bone Marrow Dataset"
author: "Ruiqi Li"
date: '2023-10-12'
output: pdf_document
bibliography: references.bib
---

# Install & Load Packages
```{r}
source("LMD_function.R")
remotes::install_github("satijalab/seurat-wrappers")
library("SeuratWrappers")
```
# Preparing input data
```{r}
# Define your own dir path
dir.path <- "/banach1/ruiqi/local_marker/LMD_data"

folder.path <- file.path(dir.path,"tabular_muris")
file_name = "marrow_facs.rds"
if (!file.exists(file.path(folder.path,file_name))) {
   # If load url doesn't work, please download it and load from your working directory
  options(timeout=6000)
  download.file("https://figshare.com/ndownloader/files/13092380",
                destfile = file.path(folder.path,file_name), method = 'libcurl')
  tiss <- readRDS(file.path(folder.path,file_name))
  tiss <- UpdateSeuratObject(tiss)
  tiss <- RunALRA(tiss, assay = "RNA"); DefaultAssay(tiss) = "RNA"
  saveRDS(tiss,file = file.path(folder.path,file_name))
}
tiss <- readRDS(file.path(folder.path,file_name))
```

We obtain the following objects from this Seurat Obj:
* `feature_space`: The output of PCA. This matrix contains the first 20 principal components (PCs).
* `visual_space`: a data.frame with t-SNE coordinates (2D) based on the first 20 PCs.
* `dat`: a matrix object with the log-normalized expression of genes (rows) in each cell (columns)
* `cell_label`: Any metadata you wish to visualize and examine related to cells (here we take the cell type annotation)
```{r}
DefaultAssay(tiss) <- "RNA"
n_dim = dim(tiss@reductions$pca@cell.embeddings)[2]
feature_space = as.matrix(tiss@reductions$pca@cell.embeddings[,1:n_dim])
visual_space = data.frame(tiss@reductions$tsne@cell.embeddings)
dat = as.matrix(tiss[[DefaultAssay(tiss)]]@data)
cell_label = tiss$cell_ontology_class
```

We process the `dat` by only keep the genes detected in more than 10 cells and less than 50% of cells (genes is "detected" in a cell only if its expression level is greater than the median expression level of that cell)

```{r}
Gene_detected_count <- apply(dat > apply(dat,2,median),1,sum)
selected_genes = (Gene_detected_count >= 10) & (Gene_detected_count <= ncol(dat) * 0.5)
dat = dat[selected_genes,,drop = FALSE]
```

# Running LMD Step by Step
This provides a step-by-step tutorial for a better understanding of the algorithm. If you want to generate results directly, please skip to 'Running LMD in One Step'

## Step1: Build KNN Graph
```{r, fig.width=20}
# Construct knn graph
knn_result = Symmetric_KNN_graph(knn = 5, feature_space = feature_space)

A = knn_result$adj_matrix # Adjacency Matrix
W = knn_result$graph # Symmetrized Graph ((A + AT) / 2)

# Plot knn graph
plot_knn_graph(affinity_m = W, label = cell_label, layout = visual_space)
```

## Step2: Diffuse Genes on the cell graph
```{r, fig.width=20}
# Generate $P^{t}, t = 2,4,8,...,max_time$
P_ls = Obtain_Pls(W = W, max_time = 2^20)
# Generate initial gene distribution
rho = Rowwise_normalize(dat[,colnames(W)])
# Check One Gene Diffusion on Cell graph by time
gene = "Fcnb"
print(FeaturePlot_diffusion(coord = visual_space,init_state = rho[gene,],P_ls = P_ls,check_time = c(2,16,128),gene_name = gene))
```

## Step3: Obtain Diffusion KL score & Cumulative score
### Obtain diffusion KL score
```{r}
score_result = fast_get_lmds(W = W, init_state = rho, P_ls = P_ls, largeData = FALSE)
```

### Diffusion KL pattern for several genes
```{r}
genes = c("Tlr11","Fcnb","Cd79a","4933425H06Rik","Uchl4","Dock11")
genes_label = rep(c("good","bad"),each = 3)
Visualize_score_pattern(score_result$'score_profile', genes = genes, label_class = genes_label, facet_class = NULL, text = TRUE, normalize = TRUE)
```

### Show result
```{r}
res = show_result_lmd(score_result,n = 10)
head(res$gene_table,10)
```

# Running LMD in one step
```{r}
tic()
lmd_result = LMD(dat, feature_space, knn = 5, max_time = 2^20)
toc()
local_gene = show_result_lmd(lmd_result)
head(local_gene$gene_table,10)
```

# Identify Gene Modules
## Step1: Deriving Gene Modules
### Select top localized genes based on knee point
```{r}
local_gene = show_result_lmd(lmd_result)
local_gene = names(local_gene$cut_off_gene)
```
### Denoising
We use ALRA @linderman2022zero to De-noise our data
```{r}
if(!"alra" %in% names(tiss@assays)){
  tiss <- RunALRA(tiss, assay = "RNA")
  DefaultAssay(tiss) <- "RNA"
}
dat_alra = as.matrix(tiss[["alra"]]@data)[local_gene,]
```
### Calculate Gene-gene co-localization distance
```{r}
distance_method = "jaccard"
dist = Calculate_distance(dat_alra, method = distance_method)
```
### Obtain Gene modules
```{r}
gene_partition = Obtain_gene_partition(dist, clustering_method = "average", min_gene = 5)
```
### Visualize
```{r}
p = Visualize_gene_heatmap(dist)
```

## Step2: Computing Per-Cell Module Activity Scores
```{r}
tiss = AddModuleActivityScore(tiss, gene_partition = gene_partition, do_local_smooth = FALSE)

FeaturePlot(tiss, features = paste0("Module",levels(gene_partition)), order = TRUE, reduction = "tsne", ncol = 3) & NoAxes() & 
  scale_color_gradient(low = "lightgrey", high = "blue", limits = c(0,1)) & labs(color = "ModuleScore") & NoLegend()
```
